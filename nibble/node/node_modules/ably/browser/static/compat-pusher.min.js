/*
 Copyright 2016, Ably

 Ably JavaScript Library v0.8.23
 https://github.com/ably/ably-js

 Ably Realtime Messaging
 https://www.ably.io

 Released under the Apache Licence v2.0
*/
(function(){var m=function(){function b(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}function g(a,d,e){try{d.apply(a,e)}catch(c){Logger.logAction(Logger.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+c+"; stack = "+c.stack)}}function f(a,d,e){var c,b,g,l;for(l=0;l<a.length;l++)if(c=a[l],e&&(c=c[e]),h.isArray(c)){for(;-1!==(b=h.arrIndexOf(c,d));)c.splice(b,1);e&&0===c.length&&delete a[l][e]}else if(h.isObject(c))for(g in c)c.hasOwnProperty(g)&&h.isArray(c[g])&&
f([c],d,g)}b.prototype.on=function(a,d){1==arguments.length&&"function"==typeof a?this.any.push(a):h.isEmptyArg(a)?this.any.push(d):(this.events[a]||(this.events[a]=[])).push(d)};b.prototype.off=function(a,d){0==arguments.length||h.isEmptyArg(a)&&h.isEmptyArg(d)?(this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={}):(1==arguments.length&&"function"==typeof a&&(d=a,a=null),h.isEmptyArg(a)?d?f([this.any,this.events,this.anyOnce,this.eventsOnce],d):(this.any=[],this.anyOnce=[]):d?f([this.events,
this.eventsOnce],d,a):(delete this.events[a],delete this.eventsOnce[a]))};b.prototype.listeners=function(a){if(a){var d=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(d,this.eventsOnce[a]);return d.length?d:null}return this.any.length?this.any:null};b.prototype.emit=function(a){var d=Array.prototype.slice.call(arguments,1),e={event:a};if(this.anyOnce.length){var c=this.anyOnce;this.anyOnce=[];for(var b=0;b<c.length;b++)g(e,c[b],d)}for(b=0;b<this.any.length;b++)this.any[b].apply(e,
d);if(c=this.eventsOnce[a])for(delete this.eventsOnce[a],b=0;b<c.length;b++)g(e,c[b],d);if(c=this.events[a])for(b=0;b<c.length;b++)g(e,c[b],d)};b.prototype.once=function(a,d){1==arguments.length&&"function"==typeof a?this.anyOnce.push(a):h.isEmptyArg(a)?this.anyOnce.push(d):(this.eventsOnce[a]||(this.eventsOnce[a]=[])).push(d)};b.prototype.whenState=function(a,d,b){var c={event:a},f=Array.prototype.slice.call(arguments,3);if("string"!==typeof a||"string"!==typeof d)throw"whenState requires a valid event String argument";
if("function"!==typeof b)throw"whenState requires a valid listener argument";if(a===d)g(c,b,f);else this.once(a,b)};return b}(),h=function(){function b(){}var g="object"==typeof window;b.mixin=function(a,d){if(d){var b=d.hasOwnProperty,c;for(c in d)if(!b||b.call(d,c))a[c]=d[c]}return a};b.copy=function(a){return b.mixin({},a)};b.isArray=Array.isArray||function(a){return"[object Array]"==Object.prototype.toString.call(a)};b.ensureArray=function(a){return b.isArray(a)?ob:[a]};b.isObject=function(a){return"[object Object]"==
Object.prototype.toString.call(a)};b.isEmpty=function(a){for(var d in a)return!1;return!0};b.isEmptyArg=function(a){return null===a||void 0===a};b.shallowClone=function(a){var d={},b;for(b in a)d[b]=a[b];return d};b.prototypicalClone=function(a,d){function e(){}e.prototype=a;var c=new e;d&&b.mixin(c,d);return c};b.inherits="undefined"!==typeof require&&require("util").inherits||function(a,d){a.super_=d;a.prototype=b.prototypicalClone(d.prototype,{constructor:a})};b.containsValue=function(a,d){for(var b in a)if(a[b]==
d)return!0;return!1};b.intersect=function(a,d){return b.isArray(d)?b.arrIntersect(a,d):b.arrIntersectOb(a,d)};b.arrIntersect=function(a,d){for(var e=[],c=0;c<a.length;c++){var f=a[c];-1!=b.arrIndexOf(d,f)&&e.push(f)}return e};b.arrIntersectOb=function(a,d){for(var b=[],c=0;c<a.length;c++){var f=a[c];f in d&&b.push(f)}return b};b.arrSubtract=function(a,d){for(var e=[],c=0;c<a.length;c++){var f=a[c];-1==b.arrIndexOf(d,f)&&e.push(f)}return e};b.arrIndexOf=Array.prototype.indexOf?function(a,b,e){return a.indexOf(b,
e)}:function(a,b,e){e=e||0;for(var c=a.length;e<c;e++)if(a[e]===b)return e;return-1};b.arrIn=function(a,d){return-1!==b.arrIndexOf(a,d)};b.arrDeleteValue=function(a,d){var e=b.arrIndexOf(a,d),c=-1!=e;c&&a.splice(e,1);return c};b.arrWithoutValue=function(a,d){var e=a.slice();b.arrDeleteValue(e,d);return e};b.keysArray=function(a,b){var e=[],c;for(c in a)b&&!a.hasOwnProperty(c)||e.push(c);return e};b.valuesArray=function(a,b){var e=[],c;for(c in a)b&&!a.hasOwnProperty(c)||e.push(a[c]);return e};b.arrForEach=
Array.prototype.forEach?function(a,b){a.forEach(b)}:function(a,b){for(var e=a.length,c=0;c<e;c++)b(a[c],c,a)};b.safeArrForEach=function(a,d){return b.arrForEach(a.slice(),d)};b.arrMap=Array.prototype.map?function(a,b){return a.map(b)}:function(a,b){for(var e=[],c=a.length,f=0;f<c;f++)e.push(b(a[f],f,a));return e};b.arrEvery=Array.prototype.every?function(a,b){return a.every(b)}:function(a,b){for(var e=a.length,c=0;c<e;c++)if(!b(a[c],c,a))return!1;return!0};b.nextTick=g?function(a){setTimeout(a,0)}:
process.nextTick;var f={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};b.defaultGetHeaders=function(a){a=a||"json";return{accept:"json"===a?f.json:f[a]+","+f.json,"X-Ably-Version":Defaults.apiVersion}};b.defaultPostHeaders=function(a){a=a||"json";return{accept:"json"===a?f.json:f[a]+","+f.json,"content-type":"json"===a?f.json:f[a],"X-Ably-Version":Defaults.apiVersion}};b.arrPopRandomElement=function(a){return a.splice(Math.floor(Math.random()*
a.length),1)[0]};b.toQueryString=function(a){var b=[];if(a)for(var e in a)b.push(encodeURIComponent(e)+"="+encodeURIComponent(a[e]));return b.length?"?"+b.join("&"):""};b.parseQueryString=function(a){for(var b,e=/([^?&=]+)=?([^&]*)/g,c={};b=e.exec(a);)c[decodeURIComponent(b[1])]=decodeURIComponent(b[2]);return c};b.now=Date.now||function(){return(new Date).getTime()};b.inspect=function(a){return JSON.stringify(a)};b.inspectError=function(a){return a&&"ErrorInfo"==a.constructor.name?a.toString():b.inspect(a)};
b.randStr=function(){return String(Math.random()).substr(2)};return b}();(function(){function b(a,b){var c=b.host||"",d=b.tlshost||"",k={key:a,tls:b.encrypted||!1,log:{level:4}};b.ablyClientId&&(k.clientId=b.ablyClientId);b.authEndpoint&&(k.authUrl=b.authEndpoint);b.auth&&b.auth.params&&(k.authParams=b.auth.params);b.auth&&b.auth.headers&&(k.authHeaders=b.auth.headers);c&&0!=c.length&&(c=c.split(":"),k.realtimeHost=k.restHost=c[0],1<c.length&&(k.port=c[1]));d&&0!=d.length&&(c=d.split(":"),1<c.length&&
(k.tlsPort=c[1]));d=this.ably=new (e||window.Ably).Realtime(k);this.clientId=k.clientId;this.connection=new g(d.connection);this.channels={}}function g(a){m.call(this);this.connection=a;var b=this;a.on(function(a){var c=n[a.previous],d=b.state=n[a.current];b.emit(d);b.emit("state_change",{previous:c,current:d});a.retryIn&&b.emit("connecting_in",a.retryIn)})}function f(a,b){var c=this;this.active=!0;this.channel=a.ably.channels.get(b);this.name=b;if(this.isPresence=0==b.indexOf("presence-"))this.members=
new d(this,a.clientId);this.channel.subscribe(function(a){JSON.stringify(this);JSON.stringify(a);c.channel.emit(a.name,a.data)});this.bindings={};this.bind_alls=[];if(this.isPresence){var e=this.channel.presence;this.entered=!1;e.subscribe("enter",function(a){c.entered&&a.clientId!==c.members.myID&&(a=c.members.addMember(a.clientId,a.clientInfo))&&c.channel.emit("pusher:member_added",a)});e.subscribe("leave",function(a){c.entered&&(a=c.members.removeMember(a.clientId))&&c.channel.emit("pusher:member_removed",
a)});e.enter(function(a){if(a=e.get())for(var b=0;b<a.length;b++)c.members.addMember(a[b].clientId,a[b].clientData);c.entered=!0;c._sendEvent("pusher:subscription_succeeded",c.members)})}this.channel.on(function(a){"attached"===this.event&&c.isPresence||("undefined"===typeof a&&(a={}),c._sendEvent(r[this.event]||this.event,a))})}function a(a,b){this.id=a;this.info=b}function d(a,b,c){this.count=0;this.members={};b&&(this.myID=b,this.me=this.addMember(b,c))}if("undefined"!==typeof window)var e=window.Ably;
else if("undefined"===typeof e){var e=require("../.."),c=require("fs"),p=require("path"),q=require("vm"),l=function(a){a=p.resolve(__dirname,a);return q.runInThisContext(c.readFileSync(a,"utf8"),a)};"undefined"===typeof h&&l("../../common/lib/util/utils.js");"undefined"===typeof m&&l("../../common/lib/util/eventemitter.js")}var n={initialized:"initialized",connecting:"connecting",connected:"connected",disconnected:"disconnected",suspended:"unavailable",closed:"disconnected",failed:"failed"},r={attached:"pusher:subscription_succeeded",
failed:"pusher:subscription_error"};b.prototype.disconnect=function(){this.ably.close();delete this.ably};b.prototype.channel=function(a){return this.channels[a]};b.prototype.subscribe=function(a){return this.channels[a]=new f(this,a)};b.prototype.unsubscribe=function(a){var b=this.channels[a];b&&(b.channel.detach(),b.active=!1,delete this.channels[a])};h.inherits(g,m);g.prototype.bind=function(){this.on.apply(this,arguments)};g.prototype.unbind=function(){this.off.apply(this,arguments)};f.prototype._sendEvent=
function(a,b){for(var c=0;c<this.bind_alls.length;c++)this.bind_alls[c](a,b);var d=this.bindings[a];if(d)for(c=0;c<d.length;c++)d[c](b)};f.prototype.bind_all=function(a){this.bind_alls.push(a)};f.prototype.unbind=function(a,b){var c=this.bindings[a];if(c)for(var d=0;d<c.length;d++)if(c[d]===b){c.splice(d,1);0==c.length&&(this.channel.off(a,this.channelBindCallback),delete this.bindings[a]);break}};f.prototype.bind=function(a,b){this.bindings[a]?this.bindings[a].push(b):this.bindings[a]=[b]};f.prototype.trigger=
function(a,b){JSON.stringify(b);if(!this.active)return!0;this.channel.publish(a,b);return!0};d.prototype.addMember=function(b,c){"undefined"===typeof c&&(c={});b in this.members?this.members[b]=c:(this.members[b]=c,this.count++);return new a(b,c)};d.prototype.removeMember=function(b){if(b in this.members){var c=this.members[b];delete this.members[b];this.count--;return new a(b,c)}};d.prototype.each=function(b){for(var c in this.members)b(new a(c,this.members[c]))};d.prototype.get=function(a){return this.members[a]};
"undefined"===typeof window?module.exports=b:window.Pusher=b})()})();
